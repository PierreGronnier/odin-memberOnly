<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/index.css" />
    <title><%= title %></title>
  </head>
  <body class="index">
    <div class="index-container">
      <% if (!user) { %>
      <div class="welcome-message">
        <h2>Welcome to our exclusive Hot Takes clubhouse</h2>
        <p>
          Please <a href="/login">login</a> or
          <a href="/register">create an account</a> to join the club.
        </p>
      </div>
      <% } else if (!user.membership) { %>
      <div class="welcome-message">
        <h2>
          Welcome <%= user.first_name %> to our exclusive Hot Takes clubhouse
        </h2>
        <p>
          Click <a href="/join-club">Join the Club</a> to become a member and
          post messages.
        </p>
      </div>
      <% } else { %>
      <div class="welcome-message">
        <h2>
          Welcome member <%= user.first_name %> to our exclusive Hot Takes
          clubhouse
        </h2>
        <p>You can post new messages in the club.</p>
      </div>
      <% } %>

      <div class="messages-container">
        <% messages.forEach(msg => { %>
        <div class="message-card" id="message-<%= msg.id %>">
          <div class="message-header">
            <span class="message-author">
              <% if (user && user.membership) { %> <%= msg.first_name %> <% }
              else { %> Anonymous <% } %>
            </span>
            <span class="message-date">
              <%= new Date(msg.created_at).toLocaleString() %>
            </span>
          </div>
          <p class="message-content"><%= msg.content %></p>
          <div class="message-footer">
            <div class="message-actions">
              <% if (user && user.membership) { %>
              <span
                class="message-likes clickable <%= msg.user_liked ? 'liked' : '' %>"
                onclick="toggleLike(<%= msg.id %>, this)"
              >
                üëç <span class="like-count"><%= msg.likes %></span>
              </span>
              <% } else { %>
              <span class="message-likes">
                üëç <span class="like-count"><%= msg.likes %></span>
              </span>
              <% } %> <% if (user && user.is_admin) { %>
              <button
                class="delete-btn"
                onclick="deleteMessage(<%= msg.id %>, this)"
                title="Delete message"
              >
                üóëÔ∏è
              </button>
              <% } %>
            </div>
          </div>
        </div>
        <% }) %>
      </div>
    </div>

    <script>
      async function toggleLike(messageId, element) {
        try {
          const response = await fetch(`/like/${messageId}`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (!result.success) {
            alert(result.error);
            return;
          }

          const likeCount = element.querySelector(".like-count");
          likeCount.textContent = result.likes;

          if (result.action === "liked") {
            element.classList.add("liked");
          } else {
            element.classList.remove("liked");
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error processing like");
        }
      }

      async function deleteMessage(messageId, element) {
        if (
          !confirm(
            "Are you sure you want to delete this message? This action cannot be undone."
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`/message/${messageId}`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (!result.success) {
            alert(result.error);
            return;
          }

          const messageElement = document.getElementById(
            `message-${messageId}`
          );
          if (messageElement) {
            messageElement.remove();
          }
        } catch (error) {
          console.error("Error:", error);
          alert("Error deleting message");
        }
      }
    </script>
  </body>
</html>
